---
title: "Regression Analysis"
output: html_document
---
<br>

```{r include=FALSE, message=FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
library(corrplot)
library(olsrr)
library(leaps)

knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 6,
  fig.asp = .7,
  dpi = 800,
  out.width = "80%"
)

theme_set(theme_minimal())

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


```{r include=FALSE, message=FALSE}
le_df = 
  read_csv("./data/Complete_Data.CSV") %>% 
  rename("HDI" = "incomecompositionofresources", "percent_exp" = "percentageexpenditure", "total_exp" = "totalexpenditure", "le" = "lifeexpectancy", "adult_mort" = "adult_mortality", "thin_1_19" = "thinness1_19years", "thin_5_9" = "thinness5_9years", "under_five" = "under_fivedeaths")
```

<br>

## Correlation Matrix

```{r}
cm_df =
  le_df %>%
  dplyr::select(-c(country,continent,year,status))

corrplot(cor(cm_df), type = "upper", diag = FALSE, method = "square", addCoef.col = "black", number.cex = .4, tl.col = "black", tl.cex = .8)
```

<br>

## Model building 


```{r include=FALSE}
#stepwise
mod_1 = lm(le ~ status + adult_mort + bmi + polio + diphtheria + hiv_aids + gdp + thin_1_19 + HDI + schooling, data = le_df)


# Nutrition 
mod_2 = lm(le ~ status + bmi + population + thin_1_19 + thin_5_9 + status * bmi + status * thin_1_19 + status * thin_5_9, data = le_df)

#Education level, GDP, health        
mod_3 = lm(le ~ status + polio + total_exp + diphtheria + gdp + schooling + total_exp * gdp, data = le_df)

#health
mod_4 = lm(le ~ polio + total_exp + diphtheria + hiv_aids + thin_1_19, data = le_df)

#full model
mod_5 = lm(le ~ year + adult_mort + infantdeaths + percent_exp + bmi + under_five + polio + diphtheria + hiv_aids + gdp + thin_5_9, data = le_df)

# health-related factors, mortality factors, economical factors and social factors
mod_6 = lm(le ~ status + percent_exp + HDI + adult_mort + infantdeaths + schooling, data = le_df)

#backward
mod_7 = lm(le ~ status + adult_mort + bmi + polio + total_exp + diphtheria + hiv_aids + gdp + thin_1_19 + HDI + schooling, data = le_df)

#forward
mod_8 = lm(le ~ status + adult_mort + bmi + under_five + polio + diphtheria + hiv_aids + gdp + thin_5_9 + HDI, data = le_df)

#best subsets selection
mod_9 = lm(le ~ adult_mort + infantdeaths + polio + hiv_aids + gdp + HDI + schooling, data = le_df)

```

## Cross Validation

```{r include=FALSE}
set.seed(2)

cv_df = 
  crossv_mc(le_df,100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  ) %>% 
  mutate(
    mod_1 = map(train, ~lm(formula = formula(mod_1), data = .x)),
    mod_2 = map(train, ~lm(formula = formula(mod_2), data = .x)),
    mod_3 = map(train, ~lm(formula = formula(mod_3), data = .x)),
    mod_4 = map(train, ~lm(formula = formula(mod_4), data = .x)),
    mod_5 = map(train, ~lm(formula = formula(mod_5), data = .x)),
    mod_6 = map(train, ~lm(formula = formula(mod_6), data = .x)),
    mod_7 = map(train, ~lm(formula = formula(mod_7), data = .x)),
    mod_8 = map(train, ~lm(formula = formula(mod_8), data = .x)),
    mod_9 = map(train, ~lm(formula = formula(mod_9), data = .x))
    ) %>% 
  mutate(
    rmse_1 = map2_dbl(mod_1, test, ~rmse(model = .x, data = .y)),
    rmse_2 = map2_dbl(mod_2, test, ~rmse(model = .x, data = .y)),
    rmse_3 = map2_dbl(mod_3, test, ~rmse(model = .x, data = .y)),
    rmse_4 = map2_dbl(mod_4, test, ~rmse(model = .x, data = .y)),
    rmse_5 = map2_dbl(mod_5, test, ~rmse(model = .x, data = .y)),
    rmse_6 = map2_dbl(mod_6, test, ~rmse(model = .x, data = .y)),
    rmse_7 = map2_dbl(mod_7, test, ~rmse(model = .x, data = .y)),
    rmse_8 = map2_dbl(mod_8, test, ~rmse(model = .x, data = .y)),
    rmse_9 = map2_dbl(mod_9, test, ~rmse(model = .x, data = .y))
    )
```


```{r}
cv_df %>% 
  pivot_longer(
    rmse_1:rmse_9,
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model),
         model = fct_recode(model, "Model 1" = "1",
                                   "Model 2" = "2",
                                   "Model 3" = "3",
                                   "Model 4" = "4",
                                   "Model 5" = "5",
                                   "Model 6" = "6",
                                   "Model 7" = "7",
                                   "Model 8" = "8",
                                   "Model 9" = "9")
         ) %>% 
  ggplot(aes(x = model, y = rmse, fill = model)) + 
  geom_violin() + 
  labs(x = "",
       y = "RMSE", 
       title = "Cross Validation") +
  scale_fill_brewer(type = 'seq', palette = 'Blues') +
  theme(legend.position = 'none',
        plot.title = element_text(hjust = 0.5))
```

## Results

```{r}
mod_1 %>% 
  broom::tidy() %>% 
  knitr::kable()
```

