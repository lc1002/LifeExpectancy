<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Predictive Model for Life Expectancy</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="report.html">Project Report</a>
</li>
<li>
  <a href="exploratory.html">Exploratory Analysis</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Regression Analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="statistical.html">Statistical Analysis</a>
    </li>
    <li>
      <a href="regression.html">Modeling</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://anmei18.shinyapps.io/interactive_map/">Interactive Map</a>
</li>
<li>
  <a href="https://github.com/lc1002/LifeExpectancy">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Predictive Model for Life Expectancy</h1>

</div>


<style type="text/css">

h1.title {
  font-size: 50px;
  text-align: left;   
  font-family: Papyrus;
  font-weight: bold;
  font-variant: small-caps
}
</style>
<p>The main objective of this study is to analyze the relationship between life expectancy and relevant variables that can potentially affect an individual’s lifespan. In conjunction with the exploratory and statistical analyses, we will now build a predictive model for life expectancy using existing data of all countries from 2000 to 2015.</p>
<p>In this page, we will first examine the correlation between life expectancy and potential predictors in our dataset using <strong>correlation matrix</strong>. Then we will propose several models based on <strong>prior research</strong> and <strong>automated model selection</strong>. Next, we will evaluate and compare the performance of the models with metrics of evaluation using <strong>cross-validation</strong>. Finally, we will report the <strong>results</strong> and draw a conclusion based on our best-fitted model.</p>
<br> <br>
<hr>
<div id="correlation-matrix" class="section level2">
<h2><strong>Correlation Matrix</strong></h2>
<p>One of the essential steps of building a regression model is to detect multicollinearity between the independent variables. Below is a table that displays correlations between variables in our dataset.</p>
<p><br></p>
<pre class="r"><code>cm_df =
  le_df %&gt;%
  dplyr::select(-c(country,continent,year))

corrplot(cor(cm_df), type = &quot;upper&quot;, diag = FALSE, method = &quot;square&quot;, addCoef.col = &quot;black&quot;, number.cex = .3, tl.col = &quot;black&quot;, tl.cex = .7)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-3-1.png" width="80%" /></p>
<p><br></p>
<p>From the correlation matrix, we can see that life expectancy has a high positive correlation with <code>HDI</code> and <code>schooling</code>, and a high negative correlation with <code>adult_mort</code> and moderate negative correlation with <code>hiv_aids</code>. Indeed, we would expect the outcome variable, life expectancy, to be highly impacted by these predictors.</p>
<p>We can also see that many of our variables are moderately correlated with each other. <code>HDI</code> highly correlated with <code>schooling</code> and moderately correlated with multiple variables. It is positively associated with <code>alcohol</code>, <code>percent_exp</code>, <code>bmi</code>, <code>gdp</code>, <code>status_Developing</code>, <code>polio_low</code>, <code>hepatitis_b_low</code> and <code>diphtheria_low</code> , and negatively associated with <code>adult_mort</code>, <code>status_Developed</code>, <code>thin_1_19</code>, <code>thin_5_9</code>,<code>polio_high</code>, <code>hepatitis_b_high</code> and <code>diphtheria_high</code>.</p>
<p>Some of our variables are also highly correlated with each other. For example, <code>gdp</code> has a strong positive correlation with <code>percent_exp</code>. The variable <code>infant deaths</code> and <code>under-five deaths</code> are highly correlated. Furthermore, <code>thin_1_19</code> and <code>thin_5_9</code> also have strong correlation with each other. In addition, dummy variables created from the same categorical variable are highly correlated as well (e.g. <code>status_Developed</code> and <code>status_Developing</code>). Therefore, multicollinearity must be taken into consideration when selecting our model.</p>
<p>(For a detailed analysis of the predictors in our dataset, please visit <a href="https://lc1002.github.io/LifeExpectancy/statistical.html">statistical analysis</a> page.)</p>
<br> <br>
<hr>
</div>
<div id="model-building" class="section level2">
<h2><strong>Model building</strong></h2>
<p>Variable selection is an essential aspect of statistical model building. Carefully selecting the truly predictive variables from a large pool of candidate predictors to build a predictive model with minimal prediction error, is often considered the most difficult step of model building. To find the best-fitted model for life expectancy prediction, we have proposed several models based on prior research and automatic model selection.</p>
<p><br></p>
<div id="model-based-on-prior-research" class="section level3">
<h3>Model Based on Prior Research</h3>
<p>Theory and findings from relevant research can provide good guidance when deciding which variables to include in the model.</p>
<p>Studies have shown that socioeconomic developments and health measures are associated with life expectancy. Lin et al. have conducted a <a href="https://bmcpublichealth.biomedcentral.com/articles/10.1186/1471-2458-12-85">study</a> to examine the longitudinal contributions of four socioeconomic indicators, economy, educational environment, nutritional status, and political regime, in less developed countries. The results of the study proven that the increases in life expectancy of less developed countries over time were associated with all four factors.(Lin et al., 2012) Another research from <a href="https://www.sciencedirect.com/science/article/pii/S0140673618316684">Kruk et al., 2018</a> shows that 58% of all amenable mortality in low-income and middle-income countries are attributed to low-quality health system. Indeed, using mortality rates as health measures, we see that low-quality health system was associated with the decrease of life expectancy in these countries. Although these studies were only conducted in less developed countries, we believe that the results are still good indicators of the determinants of life expectancy.</p>
<p>Based on prior research and analyses, we proposed the following model using socioeconomic and health-related variables from our dataset:</p>
<p><br></p>
<p><strong>Research Model:</strong></p>
<p><span class="math inline">\(Life \ Expectancy = \beta_{0} + \beta_{1}*(Developed \ Status) + \beta_{2}*(Percent \ Expenditure)\)</span> <span class="math inline">\(+ \beta_{3}*(HDI) + \beta_{4}*(Adult \ Mortality) + \beta_{5}*(Infant \ Deaths)\)</span> <span class="math inline">\(+ \beta_{6}*(Schooling) + \beta_{7}*(HIV/AIDS) + \beta_{8}*(GDP * Percent \ Expenditure)\)</span></p>
<p><br> <br></p>
</div>
<div id="models-based-on-automated-model-selection" class="section level3">
<h3>Models Based on Automated Model Selection</h3>
<p>Automated selection procedures are often used when there are many potential variables available in the data, and there are uncertainties in selecting the most appropriate variables for a reliable prediction. Using automated model selection performed in R, we have generated four models. Outlined below are the four automated model selection procedures performed: <strong>stepwise selection</strong>,<strong>backward/forward selection</strong>, <strong>best subsets selection</strong>, <strong>lasso regression</strong> and <strong>ridge regression</strong>.</p>
<p><br></p>
<div id="stepwise-regression" class="section level4">
<h4><strong>Stepwise Regression:</strong></h4>
<p>Stepwise model selection was performed using <code>stepAIC()</code> from the <code>MASS</code> package. High correlation variables and insignificant variables were detected using <code>check.collinearity()</code> from the <code>performance</code> package and <code>summary()</code> from base R, respectively. Below is the final model obtained using stepwise selection.</p>
<p><br></p>
<p><strong>Stepwise Model:</strong></p>
<p><span class="math inline">\(Life \ Expectancy = \beta_{0} + \beta_{1}*(Developed \ Status) + \beta_{2}*(Adult \ Mortality)\)</span> <span class="math inline">\(+ \beta_{3}*(BMI) + \beta_{4}*(High \ Polio) + \beta_{5}*(High \ Diphtheria)\)</span> <span class="math inline">\(+ \beta_{6}*(HIV/AIDS) + \beta_{7}*(GDP) + \beta_{8}*(Prevalence \ of \ thinness 10-19)\)</span> <span class="math inline">\(+ \beta_{9}*(HDI) + \beta_{10}*(Schooling)\)</span></p>
<p><br> <br></p>
</div>
<div id="forwardbackward-selection" class="section level4">
<h4><strong>Forward/Backward Selection:</strong></h4>
<p>Backward elimination was generated using <code>stepAIC()</code> with <code>direction = backward</code>, from the <code>MASS</code> package. Similarly, forward selection was generated using <code>stepAIC()</code> with <code>direction = forward</code>. Then, high correlation and insignificant variables were detected and removed from the resulted models. Surprisingly, after removing these variables, we obtained two identical models from the backward and forward selection, which is also the exact same model generated from the stepwise selection.</p>
<p>Since models produced by backward, forward and stepwise selection are identical, we will only include one of them in further analysis. For simplicity, we will label this model as stepwise model.</p>
<p><br></p>
</div>
<div id="best-subsets-regression" class="section level4">
<h4><strong>Best Subsets Regression:</strong></h4>
<p>Best subset regression was performed using <code>regsubsets()</code> from the <code>leaps</code> package. Unlike stepwise, forward, and backward selection that generates only one regression model, best subset regression produces multiple models after fitting all models based on the number of independent variables specified.</p>
<p>Below is a table that displays the best fitting models generated from best subset regression of different sizes.</p>
<p><br></p>
</div>
<div id="best-fitting-models-based-on-the-numbers-of-predictors" class="section level4">
<h4><em>Best Fitting Models Based on the Numbers of Predictors</em></h4>
<pre class="r"><code>table %&gt;% 
     knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">1</th>
<th align="left">2</th>
<th align="left">3</th>
<th align="left">4</th>
<th align="left">5</th>
<th align="left">6</th>
<th align="left">7</th>
<th align="left">8</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">status_Developed</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">adult_mort</td>
<td align="left"></td>
<td align="left"></td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">infantdeaths</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">alcohol</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">percent_exp</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">hepatitis_b_high</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">measles</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">bmi</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">under_five</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">polio_high</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">total_exp</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">diphtheria_high</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">hiv_aids</td>
<td align="left"></td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
</tr>
<tr class="even">
<td align="left">gdp</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">*</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">population</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">thin_1_19</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">thin_5_9</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">HDI</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
</tr>
<tr class="odd">
<td align="left">schooling</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
<td align="left">*</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>Since best subset regression did not specify the best model among the models generated, we will need to compare the model selection criteria to determine the final best subset model. Here is a plot that compares the model selection criteria across all models generated from the best subset regression:</p>
<p><br></p>
</div>
<div id="comparison-based-on-model-selection-criteria" class="section level4">
<h4><em>Comparison Based on Model Selection Criteria</em></h4>
<pre class="r"><code>Model_comparison =
  tibble(
    n_pred = c(1:8),
    &quot;Adj R2&quot; = best_summary$adjr2,
    &quot;BIC&quot; = best_summary$bic,
    &quot;Cp&quot; = best_summary$cp,
    &quot;RSE&quot; = best_summary$rsq,
    &quot;RSS&quot; = best_summary$rss
    ) %&gt;%
    gather(key = &quot;Statistics&quot;, value = &quot;value&quot;, 2:6) %&gt;%
    ggplot(aes(x = n_pred, y = value)) +
      geom_point() +
      geom_line() +
      facet_grid(Statistics ~ ., scales = &quot;free_y&quot;) +
      labs(
        x = &quot;Number of Predictors&quot;,
        y = &quot;Values&quot;,
        title = &quot;Model Selection Criteria Comparison&quot;
      )

Model_comparison</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-10-1.png" width="80%" /></p>
<p><br></p>
<p>Based on the results shown above, the model contains 8 predictors has the highest adjusted R squared and relative standard error (RSE), and the lowest bayesian Information criterion (BIC), Mallow’s Cp value, and residual sum of squares (RSS). Therefore, it is the best-fitting best subset model among all candidate models.</p>
<p>After removing high correlation variables from the resulted models, we obtained our final best subsets model.</p>
<p><br></p>
<p><strong>Best Subsets Model:</strong></p>
<p><span class="math inline">\(Life \ Expectancy = \beta_{0} + \beta_{1}*(Adult \ Mortality) + \beta_{2}*(Under-five \ Deaths)\)</span> <span class="math inline">\(+ \beta_{3}*(High \ Polio) + \beta_{4}*(HIV/AIDS) + \beta_{5}*(GDP)\)</span> <span class="math inline">\(+ \beta_{6}*(HDI) + \beta_{7}*(Schooling)\)</span></p>
<p><br> <br></p>
<p>When developing regression models for our dataset, one problem that rises to our attention is the multicollinearity, our dataset contains multiple predictor variables that are highly correlated to each other, which concerns us that they might not provide unique or independent information in the regression models.Thus, in addition to the multiple linear regression models above, we also applied regularization method to resolve multicollinearity issues using ridge regression and lasso regression.</p>
<p><br></p>
</div>
<div id="ridge-regression" class="section level4">
<h4><strong>Ridge Regression:</strong></h4>
<p><strong>Mathematical equation of Ridge Regression:</strong></p>
<p><span class="math inline">\(\sum_{i=1}^n{(y_{i} - \beta_{0} - \sum_{j=1}^{p}{\beta_{i}x_{ij}})^2} + \lambda \sum_{j=1}^{p}{\beta_{j}^2} = RSS + \lambda \sum_{j=1}^{p}{\beta_{j}^2}\)</span></p>
<pre class="r"><code>#define response variable
y = le_df$le

#define matrix of predictor variables
x = data.matrix(le_df[, c(&#39;status_Developed&#39;, &#39;adult_mort&#39;, &#39;infantdeaths&#39;, &#39;alcohol&#39;, &#39;percent_exp&#39;, &#39;hepatitis_b_high&#39;, &#39;measles&#39;, &#39;bmi&#39;, &#39;under_five&#39;, &#39;polio_high&#39;, &#39;total_exp&#39;, &#39;diphtheria_high&#39;, &#39;hiv_aids&#39;, &#39;gdp&#39;, &#39;population&#39;, &#39;thin_1_19&#39;, &#39;thin_5_9&#39;, &#39;HDI&#39;, &#39;schooling&#39;)])

#fit ridge regression model
ridge_model = glmnet(x, y, alpha = 0)
  
#perform k-fold cross-validation to find optimal lambda value
cv_ridge_model = cv.glmnet(x, y, alpha = 0)

best_lambda = cv_ridge_model$lambda.min

best_ridge_model = glmnet(x, y, alpha = 0, lambda = best_lambda)

par(mfrow=c(1,1))
#produce plot of test MSE by lambda value
plot(cv_ridge_model) + title(&quot;Plot of MSE by Lambda value&quot;,line = 2.5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-12-1.png" width="80%" /></p>
<pre><code>## integer(0)</code></pre>
<p>The lambda value that minimizes the test MSE turns out to be 0.7175106.</p>
<p><br> <br></p>
</div>
<div id="lasso-regression" class="section level4">
<h4><strong>Lasso Regression:</strong></h4>
<p><strong>Mathematical equation of Ridge Regression:</strong></p>
<p><span class="math inline">\(\sum_{i=1}^n{(y_{i} - \beta_{0} - \sum_{j=1}^{p}{\beta_{i}x_{ij}})^2} + \lambda \sum_{j=1}^{p}{|\beta_{j}|} = RSS + \lambda \sum_{j=1}^{p}{|\beta_{j}|}\)</span></p>
<pre class="r"><code>#define response variable
y = le_df$le

#define matrix of predictor variables
x = data.matrix(le_df[, c(&#39;status_Developed&#39;, &#39;adult_mort&#39;, &#39;infantdeaths&#39;, &#39;alcohol&#39;, &#39;percent_exp&#39;, &#39;hepatitis_b_high&#39;, &#39;measles&#39;, &#39;bmi&#39;, &#39;under_five&#39;, &#39;polio_high&#39;, &#39;total_exp&#39;, &#39;diphtheria_high&#39;, &#39;hiv_aids&#39;, &#39;gdp&#39;, &#39;population&#39;, &#39;thin_1_19&#39;, &#39;thin_5_9&#39;, &#39;HDI&#39;, &#39;schooling&#39;)])

lasso_model = glmnet(x, y, alpha = 1)

#perform k-fold cross-validation to find optimal lambda value
cv_lasso_model = cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lasso_lambda = cv_lasso_model$lambda.min

best_lasso_model = glmnet(x, y, alpha = 1, lambda = best_lasso_lambda)

new_x = data.matrix(le_df[, c(&#39;status_Developed&#39;, &#39;adult_mort&#39;, &#39;infantdeaths&#39;, &#39;alcohol&#39;, &#39;percent_exp&#39;, &#39;hepatitis_b_high&#39;, &#39;bmi&#39;, &#39;under_five&#39;, &#39;polio_high&#39;, &#39;total_exp&#39;, &#39;diphtheria_high&#39;, &#39;hiv_aids&#39;, &#39;gdp&#39;, &#39;thin_1_19&#39;, &#39;thin_5_9&#39;, &#39;HDI&#39;, &#39;schooling&#39;)])</code></pre>
<p>The lambda value that minimizes the test MSE turns out to be 0.003489.</p>
<pre class="r"><code>#produce plot of test MSE by lambda value
plot(cv_lasso_model) + title(&quot;Plot of MSE by Lambda value&quot;,line = 2.5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-14-1.png" width="80%" /></p>
<pre><code>## integer(0)</code></pre>
<pre class="r"><code>coef(best_lasso_model) </code></pre>
<pre><code>## 20 x 1 sparse Matrix of class &quot;dgCMatrix&quot;
##                             s0
## (Intercept)       5.681863e+01
## status_Developed  1.430978e+00
## adult_mort       -1.678470e-02
## infantdeaths      8.592883e-02
## alcohol           8.484722e-03
## percent_exp       5.070890e-05
## hepatitis_b_high  4.482229e-02
## measles          -5.057144e-09
## bmi               3.957832e-02
## under_five       -6.398781e-02
## polio_high        1.860788e+00
## total_exp         3.502150e-02
## diphtheria_high   1.147423e+00
## hiv_aids         -4.935099e-01
## gdp               4.828201e-05
## population        1.038695e-10
## thin_1_19        -5.142361e-02
## thin_5_9         -1.963396e-02
## HDI               6.284552e+00
## schooling         6.712439e-01</code></pre>
<p>The coefficients of the predictor <code>measles</code> and <code>population</code> was shrunk all the way to zero, which means it was completely removed from the model since it wasn’t influential.</p>
<br> <br>
<hr>
</div>
</div>
</div>
<div id="cross-validation" class="section level2">
<h2><strong>Cross Validation</strong></h2>
<p>Cross-validation is a statistical model evaluation method used to compare the prediction accuracy of competing models using the regression model accuracy metrics. In this section, we will use the <code>modelr</code> package to perform the cross validation process and compare the regression model accuracy metrics, including the root mean square deviation (RMSE), R-squared (R^2), and mean absolute error (MAE), across all models proposed from the <strong>Model building</strong> section above.</p>
<p>First, we will use <code>crossv_mc()</code> to generate 100 random partitions by performing the training/testing split (i.e., 80% of the random partitions will be the training datasets, and 20% will be the testing datasets). Then, we will fit all candidate models to each of our training data and obtain the corresponding RMSE, R^2 and MAE for the testing data using <code>map()</code> and <code>map2_dbl()</code>. The corresponding RMSE, R^2 and MAE will be used as a measure of our model’s prediction accuracy on the testing dataset. Finally, we will visualize the distribution of RMSE, R^2 and MAE of all models using <code>geom_violin()</code> from <code>ggplot</code>, and compare the performance of the candidate models based on the regression model accuracy metrics.</p>
<pre class="r"><code>set.seed(2)

cv_df = 
  crossv_mc(le_df, 100) %&gt;% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  ) %&gt;% 
  mutate(
    mod_1 = map(train, ~lm(formula = formula(mod_1), data = .x)),
    mod_2 = map(train, ~lm(formula = formula(mod_2), data = .x)),
    mod_3 = map(train, ~lm(formula = formula(mod_3), data = .x)),
    mod_4 = map(train, ~train(le ~ status_Developed + adult_mort + infantdeaths + alcohol + percent_exp + hepatitis_b_high + measles + bmi + under_five + polio_high + total_exp + diphtheria_high + hiv_aids + gdp + population + thin_1_19 + thin_5_9 + HDI + schooling, data = training(initial_split(le_df, prop = 0.75))[,-1], trControl=trainControl(method=&quot;cv&quot;, number = 5), method=&quot;glmnet&quot;, preProcess = c(&quot;center&quot;, &quot;scale&quot;),tuneGrid = expand.grid(alpha = 0, lambda = best_lambda)), data = .x),
    mod_5 = map(train, ~train(le ~ status_Developed + adult_mort + infantdeaths + alcohol + percent_exp + hepatitis_b_high + bmi + under_five + polio_high + total_exp + diphtheria_high + hiv_aids + gdp + thin_1_19 + thin_5_9 + HDI + schooling, data = training(initial_split(le_df, prop = 0.75))[,-1], trControl=trainControl(method=&quot;cv&quot;, number = 5), method=&quot;glmnet&quot;, preProcess = c(&quot;center&quot;, &quot;scale&quot;),tuneGrid = expand.grid(alpha = 1, lambda = best_lasso_lambda)), data = .x)) %&gt;% 
  mutate(
    rmse_1 = map2_dbl(mod_1, test, ~modelr::rmse(model = .x, data = .y)),
    rmse_2 = map2_dbl(mod_2, test, ~modelr::rmse(model = .x, data = .y)),
    rmse_3 = map2_dbl(mod_3, test, ~modelr::rmse(model = .x, data = .y)),
    rmse_4 = map2_dbl(mod_4, test, ~modelr::rmse(model = .x, data = .y)),
    rmse_5 = map2_dbl(mod_5, test, ~modelr::rmse(model = .x, data = .y))
    ) %&gt;% 
  mutate(
    mae_1 = map2_dbl(mod_1, test, ~modelr::mae(model = .x, data = .y)),
    mae_2 = map2_dbl(mod_2, test, ~modelr::mae(model = .x, data = .y)),
    mae_3 = map2_dbl(mod_3, test, ~modelr::mae(model = .x, data = .y)),
    mae_4 = map2_dbl(mod_4, test, ~modelr::mae(model = .x, data = .y)),
    mae_5 = map2_dbl(mod_5, test, ~modelr::mae(model = .x, data = .y))
    ) %&gt;% 
  mutate(
    rsq_1 = map2_dbl(mod_1, test, ~modelr::rsquare(model = .x, data = .y)),
    rsq_2 = map2_dbl(mod_2, test, ~modelr::rsquare(model = .x, data = .y)),
    rsq_3 = map2_dbl(mod_3, test, ~modelr::rsquare(model = .x, data = .y)),
    rsq_4 = map2_dbl(mod_4, test, ~modelr::rsquare(model = .x, data = .y)),
    rsq_5 = map2_dbl(mod_5, test, ~modelr::rsquare(model = .x, data = .y))
    )</code></pre>
<p><br></p>
<div id="cross-validating-with-violin-plots" class="section level3">
<h3><em>Cross-validating with Violin Plots</em></h3>
<pre class="r"><code>rmse_plot =
  rmse_table %&gt;% 
  ggplot(aes(x = model, y = rmse, fill = model)) + 
  geom_violin() + 
  labs(x = &quot;&quot;,
       y = &quot;RMSE&quot;) +
  scale_fill_brewer(type = &#39;seq&#39;, palette = &#39;Set2&#39;) +
  theme(legend.position = &#39;none&#39;,
        plot.title = element_text(hjust = 0.5))

rsq_plot =
  rsq_table %&gt;% 
  ggplot(aes(x = model, y = rsq, fill = model)) + 
  geom_violin() + 
  labs(x = &quot;&quot;,
       y = &quot;RSquared&quot;) +
  scale_fill_brewer(type = &#39;seq&#39;, palette = &#39;Set2&#39;) +
  theme(legend.position = &#39;none&#39;,
        plot.title = element_text(hjust = 0.5))

mae_plot =
  mae_table %&gt;% 
  ggplot(aes(x = model, y = mae, fill = model)) + 
  geom_violin() + 
  labs(x = &quot;&quot;,
       y = &quot;MAE&quot;) +
  scale_fill_brewer(type = &#39;seq&#39;, palette = &#39;Set2&#39;) +
  theme(legend.position = &#39;none&#39;,
        plot.title = element_text(hjust = 0.5))

rmse_plot/rsq_plot/mae_plot</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-17-1.png" width="80%" /></p>
<p><br></p>
<p>In addition, we also create a table that displays the mean RMSE, mean R^2 and mean MAE of all models.</p>
<p><br></p>
</div>
<div id="cross-validation-table" class="section level3">
<h3><em>Cross Validation Table</em></h3>
<pre class="r"><code>mean_rmse =
  rmse_table %&gt;% 
  group_by(model) %&gt;% 
  summarize(mean_rmse = mean(rmse))

mean_mae = 
  mae_table %&gt;%
  group_by(model) %&gt;% 
  summarize(mean_mae = mean(mae))

mean_rsquare = 
  rsq_table %&gt;% 
  group_by(model) %&gt;% 
  summarize(mean_rsq = mean(rsq))

Model_comparison_table =
  full_join(inner_join(mean_rmse, mean_rsquare), mean_mae) %&gt;% 
  knitr::kable()

Model_comparison_table </code></pre>
<table>
<thead>
<tr class="header">
<th align="left">model</th>
<th align="right">mean_rmse</th>
<th align="right">mean_rsq</th>
<th align="right">mean_mae</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Research Model</td>
<td align="right">4.209394</td>
<td align="right">0.8053251</td>
<td align="right">3.091406</td>
</tr>
<tr class="even">
<td align="left">Stepwise Model</td>
<td align="right">3.970951</td>
<td align="right">0.8267516</td>
<td align="right">2.964913</td>
</tr>
<tr class="odd">
<td align="left">BestSub Model</td>
<td align="right">4.073934</td>
<td align="right">0.8176339</td>
<td align="right">3.012049</td>
</tr>
<tr class="even">
<td align="left">Ridge Model</td>
<td align="right">3.946632</td>
<td align="right">0.8287651</td>
<td align="right">2.957489</td>
</tr>
<tr class="odd">
<td align="left">Lasso Model</td>
<td align="right">3.841472</td>
<td align="right">0.8377574</td>
<td align="right">2.873705</td>
</tr>
</tbody>
</table>
<br>
<hr>
</div>
</div>
<div id="results" class="section level2">
<h2><strong>Results</strong></h2>
<p>Based on performance measures among all models Lasso regression shows least Mean Absolute Error (MAE = 2.873414) and Root Mean Square Error (RMSE = 3.840274), and highest R-square value of 0.8378577. Thus, Lasso regression is considered as the best model to predict Life expectancy.</p>
<pre class="r"><code>plot(lasso_model, xvar = &quot;lambda&quot;) + title(&quot;Lasso trace plot&quot;,line = 2.5)</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-19-1.png" width="80%" /></p>
<pre><code>## integer(0)</code></pre>
<p>The trace plot illustrates how the predictors go into the model in the order of their magnitude of true linear regression coefficients.The coefficient path of each variables with respect to <span class="math inline">\(\sum_{i} |\beta_{i}|\)</span> only changes when a new predictor enters the model. When a new predictor enters the model, it affects the slope of the coefficient path of all predictors that are already in the model in a deterministic way as shown.</p>
<p>The coefficients for the best model we obtain from lasso regression are as follows:</p>
<pre class="r"><code>lasso_coeff &lt;- as.data.frame(as.matrix(coef(best_lasso_model))) %&gt;% 
  knitr::kable()

Lasso_lm &lt;- glm(le ~ status_Developed + adult_mort + infantdeaths + alcohol + percent_exp + hepatitis_b_high + bmi + under_five + polio_high + total_exp + diphtheria_high + hiv_aids + gdp + thin_1_19 + thin_5_9 + HDI + schooling, data = le_df)
summary(Lasso_lm) </code></pre>
<pre><code>## 
## Call:
## glm(formula = le ~ status_Developed + adult_mort + infantdeaths + 
##     alcohol + percent_exp + hepatitis_b_high + bmi + under_five + 
##     polio_high + total_exp + diphtheria_high + hiv_aids + gdp + 
##     thin_1_19 + thin_5_9 + HDI + schooling, data = le_df)
## 
## Deviance Residuals: 
##      Min        1Q    Median        3Q       Max  
## -20.4827   -2.1414    0.0047    2.2624   16.7343  
## 
## Coefficients:
##                    Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)       5.694e+01  4.562e-01 124.827  &lt; 2e-16 ***
## status_Developed  1.435e+00  2.583e-01   5.557 3.00e-08 ***
## adult_mort       -1.674e-02  7.685e-04 -21.784  &lt; 2e-16 ***
## infantdeaths      1.001e-01  7.830e-03  12.782  &lt; 2e-16 ***
## alcohol           1.427e-02  2.423e-02   0.589  0.55590    
## percent_exp       4.930e-05  7.960e-05   0.619  0.53577    
## hepatitis_b_high  7.112e-02  2.430e-01   0.293  0.76977    
## bmi               3.926e-02  4.704e-03   8.346  &lt; 2e-16 ***
## under_five       -7.438e-02  5.772e-03 -12.887  &lt; 2e-16 ***
## polio_high        1.836e+00  3.069e-01   5.982 2.48e-09 ***
## total_exp         3.553e-02  3.105e-02   1.144  0.25261    
## diphtheria_high   1.106e+00  3.407e-01   3.248  0.00118 ** 
## hiv_aids         -4.920e-01  1.673e-02 -29.406  &lt; 2e-16 ***
## gdp               4.913e-05  1.221e-05   4.025 5.84e-05 ***
## thin_1_19        -5.028e-02  4.620e-02  -1.088  0.27653    
## thin_5_9         -2.402e-02  4.560e-02  -0.527  0.59845    
## HDI               6.184e+00  5.926e-01  10.436  &lt; 2e-16 ***
## schooling         6.679e-01  3.869e-02  17.263  &lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for gaussian family taken to be 14.86579)
## 
##     Null deviance: 265978  on 2937  degrees of freedom
## Residual deviance:  43408  on 2920  degrees of freedom
## AIC: 16287
## 
## Number of Fisher Scoring iterations: 2</code></pre>
<p>When we compare the coefficients with the OLS, the coefficients are pretty similar since the penalization, <span class="math inline">\(\lambda\)</span>, was low.</p>
<pre class="r"><code>optimal_model = train(le ~ status_Developed + adult_mort + infantdeaths + alcohol + percent_exp + hepatitis_b_high + bmi + under_five + polio_high + total_exp + diphtheria_high + hiv_aids + gdp + thin_1_19 + thin_5_9 + HDI + schooling, data = training(initial_split(le_df, prop = 0.75))[,-1], trControl=trainControl(method=&quot;cv&quot;, number = 5), method=&quot;glmnet&quot;, preProcess = c(&quot;center&quot;, &quot;scale&quot;),tuneGrid = expand.grid(alpha = 1, lambda = best_lasso_lambda))

ggplot(varImp(optimal_model)) + 
  labs( 
    title = &quot;Most important variables from elastic CV&quot;,
    x = &quot;Predictors&quot;) </code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-21-1.png" width="80%" /></p>
<p>From the plot, the most important variables we get are <code>under-five deaths</code>, <code>infant deaths</code>, <code>Schooling</code>, <code>HIV/AIDS</code>, <code>Adult mortality</code>, <code>HDI</code>, <code>BMI</code>, and <code>High Polio</code> (Percentage of Polio immunization coverage among 1-year-olds <span class="math inline">\(\ge 80\)</span>. GDP, Diphtheria, Development Status and Polio are next influential predictors according to the variable importance graph. Lastly, <code>Thin_1_9</code>, <code>Percent_exp</code>, <code>Total_exp</code>, <code>Thin_5_9</code>, <code>Hepatitis B</code> and <code>Alcohol</code> are less important.</p>
</div>
<div id="diagnostics" class="section level2">
<h2><strong>Diagnostics</strong></h2>
<p>In order to validate our model and assess its goodness of fit, we perform regression diagnostics to evaluate our model assumptions of ordinary least squares (OLS).</p>
<pre class="r"><code>check_model(Lasso_lm, check = c(&quot;linearity&quot;, &quot;outliers&quot;, &quot;qq&quot;, &quot;normality&quot;))</code></pre>
<p><img src="regression_files/figure-html/unnamed-chunk-22-1.png" width="80%" /></p>
<p><strong>Linearity:</strong> If a linear model has been properly specified, the error term accounts for the variation in the dependent variable that the independent variables do not explain, the average value of the error term must equal zero and uncorrelated with the fitted values y^s. The line of best fit of the residuals regressed on the fitted values should have an intercept and slope of zero. The Linearity plot shows the data roughly satisfy this assumption.</p>
<p><strong>Homoscedasticity:</strong> By definition, OLS regression gives equal weight to all observations, we would expect the variance of the errors should be consistent for all observations (fitted values). From the top-left graph, we can see that the residuals tend to be dispersed about the reference line.</p>
<p><strong>Normality:</strong> To test the normality of our residuals, looking at the bottom left plot which illustrates a strong linear trend. We can say that the residuals are roughly normal, but with thick tails on both end. In addition, the distribution of the residuals in the bottom-right graph closely follows a normal distribution centered at zero. Thus, the normality assumption is satisfy.</p>
<p><strong>Influential Observations/Outliers:</strong> Outliers are unavoidable in large samples, but we checking no single outlier contributes too much variation by itself is crucial. According to the Influential Observations plot, we see that all of the points fall within the contour lines.</p>
<p>Overall, our model seems to be appropriate for the data.</p>
<br>
<hr>
<center>
<p><font size="2"> Contributors: AnMei Chen and Lynn Chen.</font><br> <font size="2">The Github repository for this website can be found <a href="https://github.com/lc1002/LifeExpectancy">here</a>, and the corresponding Github repository for this project is located <a href="https://github.com/lc1002/LifeExpectancyAnalysis">here</a>. </font></p>
<img src="image/mailman.png" alt="logo" style="width:30%; height:20%; ">
</center>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
